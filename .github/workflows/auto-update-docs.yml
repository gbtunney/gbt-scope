name: ðŸ“˜ Auto Build & Commit Docs (Post-Build Check)

on:
    push:
        branches:
            - 'changeset-release/**/*'

jobs:
    build-docs-if-needed:
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ›Žï¸ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ðŸ§± Setup Node.js & Install Dependencies!
              run: |
                  echo "ðŸ”§ Installing pnpm and project dependencies..."
                  npm install -g pnpm
                  pnpm install

            - name: ðŸ› ï¸ Run Fix and Build Docs
              run: |
                  echo "ðŸ§¼ Running fix & ðŸ“ building docs..."
                  pnpm run build:ts
                  pnpm run fix || true
                  pnpm run docs

            - name: ðŸ§¼ Check if repo is dirty after build
              id: check_dirty
              run: |
                  if [ -n "$(git status --porcelain)" ]; then
                    echo "dirty=true" >> $GITHUB_OUTPUT
                    echo "âš ï¸ Repo has uncommitted changes after build."
                    echo "ðŸ§¾ Dirty files:"
                    git status --porcelain
                  else
                    echo "dirty=false" >> $GITHUB_OUTPUT
                    echo "âœ… Repo is still clean after build."
                  fi

            - name: ðŸ’¾ Commit Updated Docs
              if: steps.check_dirty.outputs.dirty == 'true'
              run: |
                  echo "ðŸ“¦ Committing docs..."
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add .
                  if git diff --cached --quiet; then
                    echo "âœ… No docs changes to commit."
                  else
                    git commit -m "docs(root): auto-update docs on version bump"
                    git push origin HEAD
                    echo "ðŸš€ Docs updated and pushed!"
