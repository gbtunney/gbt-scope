name: ðŸŒ Create Release Branch

on:
    push:
        tags:
            - '**' # Match all tags, including scoped ones with slashes

jobs:
    create-release-branch:
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ›Žï¸ Checkout code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: ðŸ” Extract tag name and commit
              run: |
                  FULL_TAG="${GITHUB_REF#refs/tags/}"
                  echo "ðŸ“Œ Tag detected: $FULL_TAG"
                  echo "FULL_TAG=$FULL_TAG" >> $GITHUB_ENV

                  COMMIT_SHA=$(git rev-list -n 1 "$FULL_TAG")
                  echo "ðŸ§± Tag points to commit: $COMMIT_SHA"
                  echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV

            - name: ðŸ§ª Validate tag format
              run: |
                  if [[ ! "$FULL_TAG" =~ @.+@.+ ]]; then
                    echo "âš ï¸ Skipping tag '$FULL_TAG' â€” doesn't match expected pattern (e.g. @scope/pkg@1.2.3 or pkg@1.2.3)"
                    exit 0
                  fi

            - name: ðŸ“‹ List tags on this commit
              run: |
                  TAGS=$(git tag --points-at "$COMMIT_SHA" | sort)
                  COUNT=$(echo "$TAGS" | wc -l)
                  FIRST_TAG=$(echo "$TAGS" | head -n 1)
                  echo "$TAGS" > tags.txt

                  echo "ðŸ“¦ Total tags on this commit: $COUNT"
                  echo "ðŸ·ï¸ Tags: $TAGS"
                  echo "ðŸŽ¯ Primary tag chosen: $FIRST_TAG"

                  echo "COUNT=$COUNT" >> $GITHUB_ENV
                  echo "FIRST_TAG=$FIRST_TAG" >> $GITHUB_ENV

            - name: â­ï¸ Skip if not primary tag
              if: env.FULL_TAG != env.FIRST_TAG
              run: |
                  echo "ðŸš« Skipping. Not the first tag on this commit."
                  exit 0

            - name: ðŸ§  Determine release branch name
              run: |
                  VERSION="${FULL_TAG##*@}"       # get version after last "@"
                  DATE=$(date +%Y-%m-%d)

                  if [ "$COUNT" -eq 1 ]; then
                    PKG="${FULL_TAG%@*}"          # strip version
                    PKG="${PKG#@}"                # strip leading @
                    PKG="${PKG//\//-}"            # replace / with -
                    BRANCH="release-${PKG}-${VERSION}"
                    echo "ðŸ§ Single package release detected: $PKG"
                  else
                    BRANCH="release-${DATE}-${VERSION}"
                    echo "ðŸ± Multi-package release â€” using date-based branch name"
                  fi

                  echo "ðŸ“‚ Branch to create: $BRANCH"
                  echo "RELEASE_BRANCH=$BRANCH" >> $GITHUB_ENV

            - name: ðŸ”Ž Check if release branch exists
              run: |
                  if git ls-remote --exit-code --heads origin "$RELEASE_BRANCH"; then
                    echo "ðŸ›‘ Branch '$RELEASE_BRANCH' already exists. Skipping."
                    exit 0
                  fi

            - name: ðŸŒ¿ Checkout main
              uses: actions/checkout@v3
              with:
                  ref: main
                  fetch-depth: 0

            - name: ðŸš€ Create and push release branch
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git checkout -b "$RELEASE_BRANCH"
                  git push origin "$RELEASE_BRANCH"
                  echo "âœ… Release branch '$RELEASE_BRANCH' created and pushed!"
